<!DOCTYPE html >
<html>
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
		<meta charset="UTF-8">
		<title>Auswerterich</title>
	</head>
	<body>
		<p>Term <input type="Term" id="Input" value="a*(b+2c)+1" size="50"></p>
		<br>
		<button onclick="calculate()">Calculate</button>
		<p>Result</p>
		<p id="Result"></p>
		<script>

// examples
// 7^2+a^2*a^2+1-b+2b*2b+2b+3*(a+2a) = 50+a^4+b+4b^2+9a

// Open Issues:
// Parser: no exponents for variables
// 2abcd^2 is interpreted incorrectly as (2abcd)^2 = 4a^2b^2c^2d^2
// line 235: if (operators[op].test(list[i]))  does not work for ^ !?! -> ^ is a special character in a Regex
// line 228: // change to let op = 0 to process power of

// (a+b)*(c+d)*(e+f) = (ac+ad+bc+bd)*(e+f)
// y+a*(b+c)+x
// y+(a+b)*c+x


		class termElement {
			constructor(string) {
				this.coefficient = 0;
				this.exponentList = [];
				this.variableList = [];
				
				const number = RegExp('[1-9.]');
				const letter = RegExp('[a-zA-Z]');
				
				let l = string.length;
				
				// Determine coefficient
				let i = 0;
				while (i<l && number.test(string[i])) {
					i++;
				}
				this.coefficient = Number(string.substring(0, i))	
				
				// Determine variables
				let v = i;
				while (i<l && letter.test(string[i])) { 
					this.exponentList.push(1);
					this.variableList.push(string[i])
					i++; 
				}
				// sort variables works only if all exponents = 1
				this.variableList.sort();
				// coefficient = 1 for variables without coefficient
				if (this.coefficient == 0 && this.variableList.length > 0){
					this.coefficient = 1;
				}
				
			}
			convertToString() {
				let string = [];
				// if there are no variables, always output coefficient
				if (this.variableList.length == 0) {
					string = this.coefficient;				
				}
				else {
					// if there are variables and the coefficient = -1, just ouput -
					if (this.coefficient == -1) {
						string = '-';	
					} 
					// if there are variables and the coefficient = 1, don't output the coefficient
					else if (this.coefficient != 1) {
						string = this.coefficient;
					}
				}
				
				for (let i=0; i < this.variableList.length; i++) {
					string += this.variableList[i];
					if (this.exponentList[i] != 1) {
						string +='^';
						string +=this.exponentList[i];						
					}
				}
				return(string);
			}
			
			operation(operand1, operation, operand2) {
				switch(operation) {
					case '^':
						if (operand2.variableList.length == 0) {
							// power of 0 -> result = 1
							if (operand2.coefficient == 0) {
								this.coefficient = 1;
								this.variableList = [];
								this.exponentList = [];
							} 
							else {
								this.coefficient = Math.pow(operand1.coefficient,operand2.coefficient);
								if (operand1.variableList.length > 0) {
									for (let i = 0; i < operand1.variableList.length; i++) {
										this.variableList.push(operand1.variableList[i]);
										this.exponentList.push(operand1.exponentList[i] * operand2.coefficient);
									}
								}
							}
						}
						else {
							// operand2 contains variable -> error / nothing to calculate
						}
						break;
					case '*':
					case '/':
						if (operation =='*') {
							this.coefficient = operand1.coefficient * operand2.coefficient;
						}
						else {
							this.coefficient = operand1.coefficient / operand2.coefficient;	
						}
		
						let i1 = 0;
						let i2 = 0;
						while (i1 < operand1.variableList.length && i2 < operand2.variableList.length) {
							// same variable -> add / substract exponents
							if (operand1.variableList[i1] == operand2.variableList[i2]) {
								this.variableList.push(operand1.variableList[i1]);
								if (operation =='*') {
									this.exponentList.push(operand1.exponentList[i1] + operand2.exponentList[i2]);
								}
								else {
									this.exponentList.push(operand1.exponentList[i1] - operand2.exponentList[i2]);
								}
								i1++;
								i2++;
							} 
							// copy variable of operand1
							else if (operand1.variableList[i1] < operand2.variableList[i2]) {
								this.variableList.push(operand1.variableList[i1]);
								this.exponentList.push(operand1.exponentList[i1]);
								i1++;
							}
							// copy variable of operand2
							else {
								this.variableList.push(operand2.variableList[i2]);
								this.exponentList.push(operand2.exponentList[i2]);
								i2++;
							}
						}
						// copy remaining variables of operand1
						if (i2 == operand2.variableList.length) {
							while (i1 < operand1.variableList.length) {
								this.variableList.push(operand1.variableList[i1]);
								this.exponentList.push(operand1.exponentList[i1]);
								i1++;
							}
						}
						// copy remaining variables of operand2
						else {
							while (i2 < operand2.variableList.length) {
								this.variableList.push(operand2.variableList[i2]);
								this.exponentList.push(operand2.exponentList[i2]);
								i2++;	
							}
						}
						break;
					case '+':
					case '-':
						if (operand1.variableList.length == operand2.variableList.length) {
							// variables and exponents of operand1 and operand2 are the same?
							let varExEqual = true;
							let i = 0;
							while (i < operand1.variableList.length && varExEqual) {
								varExEqual = (operand1.variableList[i] == operand2.variableList[i] &&
										   operand1.exponentList[i] == operand2.exponentList[i]);
								i++;
							}
							// variables and exponents of operand1 and operand2 are the same => calculate result
							if (varExEqual) {
								if (operation == '+') {
									this.coefficient = operand1.coefficient + operand2.coefficient;
								}
								else {
									this.coefficient = operand1.coefficient - operand2.coefficient;
								}
								// copy variables and exponents to result
								for (let h = 0; h < operand1.variableList.length; h++) {
									this.variableList.push(operand1.variableList[h]);
									this.exponentList.push(operand1.exponentList[h]);
								}
							}
						}
						break;
				}
			}
		}
		
		class term {
			constructor(input) {
				this.list = [];
				
				const regex = RegExp('[+-\/\*^()]');
				
				let l = input.length;
				let j = 0;
				let i = 0;
				
				for (i = 0; i < l; i++) {
					if (regex.test(input[i])) {
						if (i!=j) {
//							this.list.push(input.substring(j, i));
							this.list.push(new termElement(input.substring(j, i)));
						}
						this.list.push(input[i]);
						j = i + 1;
					}
				}
				if (i!=j) {
//					list.push(Number(input.substring(j, l)));
					this.list.push(new termElement(input.substring(j, l)));
				}
			}
			
			convertToString() {
				let string = [];
				for (let i=0; i < this.list.length; i++) {
					if (typeof(this.list[i])=='string') {
						switch(this.list[i]) {
							// turn +- into -
							case '+':
								if (this.list[i+1].coefficient < 0) {
									string += '-';									
								}
								else {
									string += this.list[i];									
								}
								break;
							// turn -- into +
							case '-':
								if (this.list[i+1].coefficient < 0) {
									this.list[i+1].coefficient = -this.list[i+1].coefficient; 
									string += '+';									
								}	
								else {
									string += this.list[i];									
								}
								break;
							default:
								string += this.list[i];
						}
					}
					else {
						string += this.list[i].convertToString();								
					}
				}
				return(string);
			}
			
			calculate() {
				console.log('----- Start of Calculate -----');
				compute_brackets(this.list, 0);
				console.log('----- End of Calculate -----');

				function compute_brackets(List, start) {
					let i = start;
					
					while (i < List.length && List[i]!=')') {
						if (List[i] == '(') { 
							compute_brackets(List, i+1);
							// remove brackets if only one operand in brackets
							if (List[i+2] == ')') {
								List.splice(i+2, 1);
								List.splice(i,1);	
							}
							else {
								// find next closing bracket
								while (i < List.length && List[i]!=')') {
									i++;
								}
								// skip over next closing bracket
								i++;
							}
						}
						i++;
					}
					compute_operators(List, start, i-1);
				}
				
				function compute_operators_old(list, start, end) {

					// excution order: power of, multiplying / deviding, plus / minus			
					let operators = [RegExp('\^'), RegExp('[\/\*]'), RegExp('[+-]')];
		
					// change to let op = 0 to process power of
					for (let op = 1; op < operators.length; op++){
						// start with first operator
						let i = start+1;
						
						while (i<end){
							let result = new termElement('0');
							// execute only operators selected by parameter operators
							if (operators[op].test(list[i])) {
								console.log('Compute: ' + list[i-1].convertToString(), list[i], list[i+1].convertToString());
								// calculate result = operand1 operation operand2
								result.operation(list[i-1], list[i], list[i+1]);
								if (result.coefficient != 0) {
									// replace operand1, operator and operand2 by result
									list.splice(i-1,3,result);
									end -=2;
									console.log('Result: ' + list[i-1].convertToString());
								}
								else {
									i+=2;
								}
							}
							else {
							// next operator
							i+=2;
							}
						}
					}
				}	

				function compute_operators(list, start, end) {
					expand_brackets(list, start, end);
					
					// excution order: power of, multiplying / deviding, plus / minus			
					let operators = [RegExp('\^'), RegExp('[\/\*]'), RegExp('[+-]')];
		
					for (let op = 0; op < operators.length; op++){
						// start with first operator
						let i = start + 1;
						
						while (i < end){
							let result = new termElement('0');
							// execute only operators selected by parameter operators
//							if (operators[op].test(list[i])) {
							if ((operators[op].test(list[i]) && op > 0) ||
								(list[i] == '^' && op == 0)) {
								if (op == 2) {
									// add all operands in list
									let j = i + 1;
									while (j <= end) {
										console.log('Try adding / substracting i=' + i + ': ' + list[i-1].convertToString() + '   j=' + j + ': ' + list[j].convertToString());
										if (i > 1 && list[i-2] =='-') {
											// if op1 == - than turn op2 from - to +
											if (list[j-1] == '-') {
												result.operation(list[i-1], '+', list[j]);												
											}
											// if op1 == - than turn op2 from + to -
											else {
												result.operation(list[i-1], '-', list[j]);													
											}
										}
										else {
											// calculate result = operand1 operation operand2
											result.operation(list[i-1], list[j-1], list[j]);
										}
										// if operation is successful, replace operand1, operator and operand2 by result
										if (result.coefficient != 0) {
											// replace operand1 by result
											list.splice(i-1, 1 ,result);
											// remove operator and operand2
											list.splice(j-1, 2);											
											end -=2;
											result = new termElement('0');
											console.log('Result: ' + list[i-1].convertToString());
										}
										else {
											j+=2;
										}
									}
									i+=2;									
								}
								else {
									console.log('Compute: ' + list[i-1].convertToString(), list[i], list[i+1].convertToString());
									// calculate result = operand1 operation operand2
									result.operation(list[i-1], list[i], list[i+1]);
									if (result.coefficient != 0) {
										// replace operand1, operator and operand2 by result
										list.splice(i-1,3,result);
										end -=2;
										console.log('Result: ' + list[i-1].convertToString());
									}
									else {
										i+=2;
									}
								}
							}
							else {
							// next operator
							i+=2;
							}
						}
					}
				}
				
				function expand_brackets(list, start, end) {
					let i = start;
					let openingBracket1 = -1;
					let closingBracket1 = -1;
					let openingBracket2 = -1;
					let closingBracket2 = -1;

// (a+b)*(c+d)*(e+f) = (ac+ad+bc+bd)*(e+f)
// y+a*(b+c)+x
// y+(a+b)*c+x

					while (i < end) {
						while (i < end && list[i]!='(') {
							i++;
						}
						if (list[i]=='(') {
							if (start <= i-2 && list[i-1] == '*') {						
								if (start <= i-2 && list[i-2] == ')') {
									// found )*( in (a+b)*(c+d)
									openingBracket2 = i;
									closingBracket1 = i-2;									
								}
								else {
									// found a*( in a*(b+c)						
									openingBracket1 = i-2;
									closingBracket1 = i-2;
									openingBracket2 = i;									
								}
							}
							else {
								openingBracket1 = i;	
							}
						}
						while (i < end && list[i]!=')') {
							i++;
						}
						if (list[i]==')') {
							if (closingBracket1 == -1) {
								closingBracket1 = i;
								if (i+2 <= end && list[i+1]=='*' && list[i+2] != '(') {
									// found )*c in y+(a+b)*c
									openingBracket2 = i+2;
									closingBracket2 = i+2;
									i+=2;
								}
							}
							else {
								closingBracket2 = i;
							}
						}
						if (closingBracket2 !=-1) {
							console.log('openingBracket1: ' + openingBracket1 + ' closingBracket1: ' + closingBracket1);
							console.log('openingBracket2: ' + openingBracket2 + ' closingBracket2: ' + closingBracket2);
						}
					}
				}
			}
		}

			function calculate() {
				Term = new term(Input.value);
				Term.calculate();
				output(Term.convertToString());
	
				// Result = new termElement('0');
				// Operand1 = new termElement('2ac');
				// Operand2 = new termElement('2ad');
				// Result.operation(Operand1, '*', Operand2);
				// output(Result.convertToString());			
			}
				
			function output(string) {
				document.getElementById("Result").innerHTML = string;
			}
		</script>
	</body>
</html>